{
  "openapi": "3.0.3",
  "info": {
    "title": "Colby Recipe Backend API",
    "version": "1.1.0",
    "description": "Programmatic interface for MenuForge recipe ingestion, personalization, and menu planning."
  },
  "servers": [
    {
      "url": "https://colby-recipe-backend.example.workers.dev",
      "description": "Production"
    }
  ],
  "security": [
    { "ApiKeyAuth": [] },
    { "BearerAuth": [] }
  ],
  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "Worker scoped API key."
      },
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "TOKEN",
        "description": "Worker scoped API key presented as a bearer token."
      }
    },
    "schemas": {
      "RecipeSummary": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "cuisine": { "type": ["string", "null"] },
          "tags": {
            "type": "array",
            "items": { "type": "string" }
          },
          "heroImageUrl": { "type": ["string", "null"] }
        },
        "required": ["id", "title", "tags"]
      },
      "ChatIngredientsRequest": {
        "type": "object",
        "properties": {
          "ingredients": {
            "type": "array",
            "items": { "type": "string" }
          },
          "theme": { "type": "string" },
          "tools": {
            "type": "array",
            "items": { "type": "string" }
          },
          "userId": { "type": "string" }
        },
        "required": ["ingredients"]
      },
      "ChatIngredientsResponse": {
        "type": "object",
        "properties": {
          "suggestions": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/RecipeSummary" }
          },
          "message": { "type": "string" }
        },
        "required": ["suggestions", "message"]
      },
      "TranscribeResponse": {
        "type": "object",
        "properties": {
          "text": { "type": "string" }
        },
        "required": ["text"]
      },
      "IngestionRequest": {
        "type": "object",
        "properties": {
          "url": { "type": "string", "format": "uri" }
        },
        "required": ["url"]
      },
      "NormalizedRecipe": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "cuisine": { "type": "string" },
          "tags": {
            "type": "array",
            "items": { "type": "string" }
          },
          "heroImageUrl": { "type": "string" },
          "yield": { "type": "string" },
          "prepTimeMinutes": { "type": ["integer", "null"] },
          "cookTimeMinutes": { "type": ["integer", "null"] },
          "totalTimeMinutes": { "type": ["integer", "null"] },
          "ingredients": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "name": { "type": "string" },
                "quantity": { "type": "string" },
                "notes": { "type": "string" }
              },
              "required": ["name"]
            }
          },
          "steps": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "title": { "type": "string" },
                "instruction": { "type": "string" }
              },
              "required": ["instruction"]
            }
          },
          "tools": {
            "type": "array",
            "items": { "type": "string" }
          },
          "notes": { "type": "string" },
          "sourceUrl": { "type": "string" }
        },
        "required": ["id", "title", "ingredients", "steps"]
      },
      "IngestionResponse": {
        "type": "object",
        "properties": {
          "recipe": { "$ref": "#/components/schemas/NormalizedRecipe" }
        },
        "required": ["recipe"]
      },
      "Preferences": {
        "type": "object",
        "properties": {
          "userId": { "type": "string" },
          "cuisines": {
            "type": "array",
            "items": { "type": "string" }
          },
          "dislikedIngredients": {
            "type": "array",
            "items": { "type": "string" }
          },
          "favoredTools": {
            "type": "array",
            "items": { "type": "string" }
          },
          "notes": { "type": "string" },
          "updatedAt": { "type": "string", "format": "date-time" }
        },
        "required": ["userId", "cuisines", "dislikedIngredients", "favoredTools"]
      },
      "PreferencesRequest": {
        "type": "object",
        "properties": {
          "userId": { "type": "string" },
          "cuisines": { "oneOf": [ { "type": "array", "items": { "type": "string" } }, { "type": "string" } ] },
          "dislikedIngredients": { "oneOf": [ { "type": "array", "items": { "type": "string" } }, { "type": "string" } ] },
          "favoredTools": { "oneOf": [ { "type": "array", "items": { "type": "string" } }, { "type": "string" } ] },
          "notes": { "type": "string" }
        },
        "required": ["userId"]
      },
      "LogsResponse": {
        "type": "object",
        "properties": {
          "items": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "ts": { "type": "string" },
                "level": { "type": "string" },
                "route": { "type": "string" },
                "method": { "type": "string" },
                "status": { "type": "integer" },
                "ms": { "type": "integer" },
                "msg": { "type": "string" },
                "meta": { "type": "object" }
              },
              "required": ["ts", "level", "route", "method", "status", "ms", "msg", "meta"]
            }
          }
        },
        "required": ["items"]
      },
      "Recipe": {
        "allOf": [
          { "$ref": "#/components/schemas/RecipeSummary" },
          {
            "type": "object",
            "properties": {
              "author": { "type": ["string", "null"] },
              "description": { "type": ["string", "null"] },
              "ingredients_json": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Ingredients serialized as JSON array"
              },
              "steps_json": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Preparation steps serialized as JSON array"
              }
            }
          }
        ]
      },
      "Menu": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "nullable": true },
          "title": { "type": "string" },
          "week_start": { "type": "string", "format": "date" },
          "items_json": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "day": { "type": "string" },
                "meal": { "type": "string" },
                "recipe_id": { "type": "string" }
              },
              "required": ["day", "meal", "recipe_id"]
            },
            "description": "Serialized as JSON array"
          }
        }
      },
      "Event": {
        "type": "object",
        "properties": {
          "event_type": { "type": "string" },
          "recipe_id": { "type": ["string", "null"] },
          "value": { "type": ["string", "null"] }
        },
        "required": ["event_type"]
      }
    }
  },
  "paths": {
    "/api/chat/ingredients": {
      "post": {
        "summary": "Generate recipe suggestions from ingredients",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ChatIngredientsRequest" },
              "example": {
                "ingredients": ["peach", "basil", "goat cheese"],
                "theme": "summer picnic",
                "tools": ["air_fryer"],
                "userId": "household-123"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Chat response and recipe suggestions",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ChatIngredientsResponse" }
              }
            }
          }
        }
      }
    },
    "/api/transcribe": {
      "post": {
        "summary": "Transcribe audio to text",
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary"
                  }
                },
                "required": ["file"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Transcription text",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TranscribeResponse" }
              }
            }
          }
        }
      }
    },
    "/api/ingest/url": {
      "post": {
        "summary": "Ingest a recipe from a URL",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/IngestionRequest" },
              "example": { "url": "https://example.com/recipes/roasted-peaches" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Normalized recipe payload",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/IngestionResponse" }
              }
            }
          }
        }
      }
    },
    "/api/ingest/image": {
      "post": {
        "summary": "Ingest a recipe from image uploads",
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": {
                    "type": "array",
                    "items": { "type": "string", "format": "binary" }
                  }
                },
                "required": ["file"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Normalized recipe payload",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/IngestionResponse" }
              }
            }
          }
        }
      }
    },
    "/api/prefs": {
      "get": {
        "summary": "Get stored user preferences",
        "parameters": [
          {
            "name": "userId",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "User preferences",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "preferences": { "$ref": "#/components/schemas/Preferences" }
                  }
                }
              }
            }
          }
        }
      },
      "put": {
        "summary": "Upsert user preferences",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PreferencesRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated preferences",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "preferences": { "$ref": "#/components/schemas/Preferences" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/themes/suggest": {
      "get": {
        "summary": "Suggest recipes for a seasonal or ingredient theme",
        "parameters": [
          {
            "name": "seed",
            "in": "query",
            "required": true,
            "schema": { "type": "string" },
            "example": "peach"
          }
        ],
        "responses": {
          "200": {
            "description": "Theme recommendations",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "theme": { "type": "string" },
                    "recipes": {
                      "type": "array",
                      "items": { "$ref": "#/components/schemas/RecipeSummary" }
                    }
                  },
                  "required": ["theme", "recipes"]
                }
              }
            }
          }
        }
      }
    },
    "/api/logs": {
      "get": {
        "summary": "Fetch recent structured request logs",
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 100 }
          },
          {
            "name": "level",
            "in": "query",
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Log entries",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/LogsResponse" }
              }
            }
          }
        }
      }
    },
    "/api/recipes/batch-scan": {
      "post": {
        "summary": "Scan a batch of recipe URLs",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "urls": {
                    "type": "array",
                    "items": { "type": "string", "format": "uri" }
                  }
                },
                "required": ["urls"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Batch scan outcome",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "url": { "type": "string", "format": "uri" },
                          "success": { "type": "boolean" },
                          "id": { "type": ["string", "null"] },
                          "error": { "type": ["string", "null"] }
                        },
                        "required": ["url", "success"]
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes": {
      "get": {
        "summary": "List recipes with ranking",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Full text search term"
          },
          {
            "name": "tag",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "cuisine",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 24 }
          }
        ],
        "responses": {
          "200": {
            "description": "Ranked recipes",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "recipes": {
                      "type": "array",
                      "items": { "$ref": "#/components/schemas/RecipeSummary" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/{id}": {
      "get": {
        "summary": "Fetch a recipe",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Recipe payload",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "recipe": { "$ref": "#/components/schemas/Recipe" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Not found"
          }
        }
      }
    },
    "/api/recipes/{id}/rating": {
      "get": {
        "summary": "Get the current user's rating",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Rating information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "rating": {
                      "type": "object",
                      "properties": {
                        "stars": { "type": "integer", "minimum": 1, "maximum": 5 },
                        "notes": { "type": ["string", "null"] },
                        "cooked_at": { "type": ["string", "null"], "format": "date" }
                      }
                    },
                    "stars": { "type": ["integer", "null"] }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create or update a rating",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "stars": { "type": "integer", "minimum": 1, "maximum": 5 },
                  "notes": { "type": "string" },
                  "cooked_at": { "type": "string", "format": "date" }
                },
                "required": ["stars"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rating stored",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/favorites/{id}": {
      "post": {
        "summary": "Add a recipe to favorites",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Favorite added",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Remove a recipe from favorites",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Favorite removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/events": {
      "post": {
        "summary": "Track a custom event",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Event" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Event stored",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/menus/generate": {
      "post": {
        "summary": "Generate a weekly menu",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "week_start": { "type": "string", "format": "date" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Menu generated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "items": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "day": { "type": "string" },
                          "meal": { "type": "string" },
                          "recipe_id": { "type": "string" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/menus/{id}": {
      "get": {
        "summary": "Retrieve a saved menu",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Menu payload",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "menu": { "$ref": "#/components/schemas/Menu" }
                  }
                }
              }
            }
          },
          "404": { "description": "Not found" }
        }
      },
      "put": {
        "summary": "Update a menu",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "day": { "type": "string" },
                        "meal": { "type": "string" },
                        "recipe_id": { "type": "string" }
                      },
                      "required": ["day", "meal", "recipe_id"]
                    }
                  }
                },
                "required": ["items"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Menu updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/search/suggest": {
      "get": {
        "summary": "Auto-complete recipe titles",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Suggestions list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "suggestions": {
                      "type": "array",
                      "items": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/search/scrape": {
      "post": {
        "summary": "Queue URLs for crawling",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "urls": {
                    "type": "array",
                    "items": { "type": "string", "format": "uri" }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Scrape request accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "queued": { "type": "integer" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/{id}/print": {
      "get": {
        "summary": "Download a printable recipe",
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "format", "in": "query", "schema": { "type": "string", "enum": ["html"], "default": "html" } }
        ],
        "responses": {
          "200": {
            "description": "Printable HTML",
            "content": {
              "text/html": {
                "schema": { "type": "string" }
              }
            }
          },
          "404": { "description": "Not found" }
        }
      }
    },
    "/api/chat": {
      "post": {
        "summary": "Stream chat completions",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "messages": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "role": { "type": "string", "enum": ["user", "assistant", "system"] },
                        "content": { "type": "string" }
                      },
                      "required": ["role", "content"]
                    }
                  }
                },
                "required": ["messages"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Server-sent events stream",
            "content": {
              "text/event-stream": {
                "schema": { "type": "string" }
              }
            }
          }
        }
      }
    }
  }
}