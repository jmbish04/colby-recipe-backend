{
  "openapi": "3.0.3",
  "info": {
    "title": "Colby Recipe Backend API",
    "version": "1.0.0",
    "description": "Programmatic interface for MenuForge recipe ingestion, personalization, and menu planning."
  },
  "servers": [
    {
      "url": "https://colby-recipe-backend.example.workers.dev",
      "description": "Production"
    }
  ],
  "security": [
    { "ApiKeyAuth": [] },
    { "BearerAuth": [] }
  ],
  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "Worker scoped API key."
      },
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "TOKEN",
        "description": "Worker scoped API key presented as a bearer token."
      }
    },
    "schemas": {
      "RecipeSummary": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "title": { "type": "string" },
          "hero_image_url": { "type": ["string", "null"], "format": "uri" },
          "cuisine": { "type": ["string", "null"] },
          "tags": { "type": ["string", "null"], "description": "Comma-delimited tags" },
          "created_at": { "type": "string", "format": "date-time", "nullable": true }
        }
      },
      "Recipe": {
        "allOf": [
          { "$ref": "#/components/schemas/RecipeSummary" },
          {
            "type": "object",
            "properties": {
              "author": { "type": ["string", "null"] },
              "description": { "type": ["string", "null"] },
              "ingredients_json": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Ingredients serialized as JSON array"
              },
              "steps_json": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Preparation steps serialized as JSON array"
              }
            }
          }
        ]
      },
      "Menu": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "nullable": true },
          "title": { "type": "string" },
          "week_start": { "type": "string", "format": "date" },
          "items_json": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "day": { "type": "string" },
                "meal": { "type": "string" },
                "recipe_id": { "type": "string" }
              },
              "required": ["day", "meal", "recipe_id"]
            },
            "description": "Serialized as JSON array"
          }
        }
      },
      "Event": {
        "type": "object",
        "properties": {
          "event_type": { "type": "string" },
          "recipe_id": { "type": ["string", "null"] },
          "value": { "type": ["string", "null"] }
        },
        "required": ["event_type"]
      }
    }
  },
  "paths": {
    "/api/auth/dev-login": {
      "post": {
        "summary": "Create a development session",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "user_id": { "type": "string" },
                  "name": { "type": "string" },
                  "email": { "type": "string", "format": "email" }
                },
                "required": ["user_id"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Session token created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "token": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/scan": {
      "post": {
        "summary": "Scan and ingest a single recipe",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "url": { "type": "string", "format": "uri" }
                },
                "required": ["url"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Recipe queued or stored",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/batch-scan": {
      "post": {
        "summary": "Scan a batch of recipe URLs",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "urls": {
                    "type": "array",
                    "items": { "type": "string", "format": "uri" }
                  }
                },
                "required": ["urls"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Batch scan outcome",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "url": { "type": "string", "format": "uri" },
                          "success": { "type": "boolean" },
                          "id": { "type": ["string", "null"] },
                          "error": { "type": ["string", "null"] }
                        },
                        "required": ["url", "success"]
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes": {
      "get": {
        "summary": "List recipes with ranking",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Full text search term"
          },
          {
            "name": "tag",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "cuisine",
            "in": "query",
            "schema": { "type": "string" }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": { "type": "integer", "default": 24 }
          }
        ],
        "responses": {
          "200": {
            "description": "Ranked recipes",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "recipes": {
                      "type": "array",
                      "items": { "$ref": "#/components/schemas/RecipeSummary" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/{id}": {
      "get": {
        "summary": "Fetch a recipe",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Recipe payload",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "recipe": { "$ref": "#/components/schemas/Recipe" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Not found"
          }
        }
      }
    },
    "/api/recipes/{id}/rating": {
      "get": {
        "summary": "Get the current user's rating",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Rating information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "rating": {
                      "type": "object",
                      "properties": {
                        "stars": { "type": "integer", "minimum": 1, "maximum": 5 },
                        "notes": { "type": ["string", "null"] },
                        "cooked_at": { "type": ["string", "null"], "format": "date" }
                      }
                    },
                    "stars": { "type": ["integer", "null"] }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create or update a rating",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "stars": { "type": "integer", "minimum": 1, "maximum": 5 },
                  "notes": { "type": "string" },
                  "cooked_at": { "type": "string", "format": "date" }
                },
                "required": ["stars"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rating stored",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/favorites/{id}": {
      "post": {
        "summary": "Add a recipe to favorites",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Favorite added",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "Remove a recipe from favorites",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Favorite removed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/events": {
      "post": {
        "summary": "Track a custom event",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Event" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Event stored",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/menus/generate": {
      "post": {
        "summary": "Generate a weekly menu",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "week_start": { "type": "string", "format": "date" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Menu generated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": { "type": "string" },
                    "items": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "day": { "type": "string" },
                          "meal": { "type": "string" },
                          "recipe_id": { "type": "string" }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/menus/{id}": {
      "get": {
        "summary": "Retrieve a saved menu",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Menu payload",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "menu": { "$ref": "#/components/schemas/Menu" }
                  }
                }
              }
            }
          },
          "404": { "description": "Not found" }
        }
      },
      "put": {
        "summary": "Update a menu",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "day": { "type": "string" },
                        "meal": { "type": "string" },
                        "recipe_id": { "type": "string" }
                      },
                      "required": ["day", "meal", "recipe_id"]
                    }
                  }
                },
                "required": ["items"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Menu updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/search/suggest": {
      "get": {
        "summary": "Auto-complete recipe titles",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Suggestions list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "suggestions": {
                      "type": "array",
                      "items": { "type": "string" }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/search/scrape": {
      "post": {
        "summary": "Queue URLs for crawling",
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "urls": {
                    "type": "array",
                    "items": { "type": "string", "format": "uri" }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Scrape request accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "queued": { "type": "integer" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/recipes/{id}/print": {
      "get": {
        "summary": "Download a printable recipe",
        "parameters": [
          { "name": "id", "in": "path", "required": true, "schema": { "type": "string" } },
          { "name": "format", "in": "query", "schema": { "type": "string", "enum": ["html", "pdf"], "default": "html" } }
        ],
        "responses": {
          "200": {
            "description": "Printable HTML",
            "content": {
              "text/html": {
                "schema": { "type": "string" }
              }
            }
          },
          "404": { "description": "Not found" }
        }
      }
    },
    "/api/chat": {
      "post": {
        "summary": "Stream chat completions",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "messages": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "role": { "type": "string", "enum": ["user", "assistant", "system"] },
                        "content": { "type": "string" }
                      },
                      "required": ["role", "content"]
                    }
                  }
                },
                "required": ["messages"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Server-sent events stream",
            "content": {
              "text/event-stream": {
                "schema": { "type": "string" }
              }
            }
          }
        }
      }
    }
  }
}
