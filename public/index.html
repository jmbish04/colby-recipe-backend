<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MenuForge API Console</title>
  <style>
    :root { color-scheme: light dark; font-family: system-ui, sans-serif; }
    body { margin: 0 auto; padding: 2rem 1rem 6rem; max-width: 960px; background: var(--bg, #f8f9fa); color: var(--fg, #212529); }
    h1, h2 { margin-bottom: 0.25rem; }
    section { border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); }
    label { display: block; font-weight: 600; margin-top: 0.5rem; }
    input[type="text"], input[type="url"], textarea { width: 100%; padding: 0.6rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font: inherit; }
    textarea { min-height: 90px; }
    button { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.55rem 1.2rem; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; }
    button.secondary { background: #0f172a; }
    button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; flex-wrap: wrap; gap: 1rem; }
    .row > div { flex: 1 1 240px; }
    .tools { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .tools label { display: inline-flex; align-items: center; gap: 0.35rem; font-weight: 500; border: 1px solid rgba(0,0,0,0.08); padding: 0.4rem 0.75rem; border-radius: 999px; }
    pre { background: rgba(15,23,42,0.85); color: #f8fafc; padding: 0.75rem; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-break: break-word; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { border-bottom: 1px solid rgba(148,163,184,0.4); padding: 0.4rem 0.6rem; text-align: left; vertical-align: top; }
    tbody tr:nth-child(odd) { background: rgba(148,163,184,0.08); }
    details summary { cursor: pointer; font-weight: 600; }
    .pill { display: inline-flex; align-items: center; justify-content: center; padding: 0.2rem 0.55rem; border-radius: 999px; background: rgba(37,99,235,0.15); color: #1d4ed8; font-size: 0.75rem; font-weight: 600; }
    footer { margin-top: 2rem; text-align: center; font-size: 0.85rem; color: rgba(15,23,42,0.7); }
  </style>
</head>
<body>
  <header>
    <h1>MenuForge API Console</h1>
    <p>Experiment with chat, voice, ingestion, personalization, and observability APIs. Provide an API key to begin. Documentation lives at <a href="/openapi.json">/openapi.json</a>.</p>
  </header>

  <section>
    <h2>Authentication</h2>
    <label for="apiKey">API Key</label>
    <input id="apiKey" type="text" placeholder="Enter X-API-Key or Bearer token" />
    <p style="margin-top:0.5rem;font-size:0.9rem;color:rgba(15,23,42,0.7);">Stored locally in this browser only.</p>
  </section>

  <section id="voice">
    <h2>Voice memo ‚Üí Ingredients</h2>
    <p>Record a short pantry rundown. We transcribe it and drop the text into the chat textarea.</p>
    <div class="row" style="align-items:center;">
      <button id="recordBtn">üéôÔ∏è Start recording</button>
      <span id="recordingStatus" class="pill" hidden>Recording‚Ä¶</span>
      <button id="stopBtn" class="secondary" disabled>‚èπ Stop</button>
    </div>
    <p id="transcribeResult"></p>
  </section>

  <section id="chat">
    <h2>On-hand chat</h2>
    <label for="ingredients">Ingredients (comma separated)</label>
    <textarea id="ingredients" placeholder="tomatoes, basil, mozzarella"></textarea>
    <label for="theme">Theme</label>
    <input id="theme" type="text" placeholder="e.g. summer picnic" />
    <div class="row">
      <div>
        <label for="userId">User ID (optional personalization)</label>
        <input id="userId" type="text" placeholder="household-123" />
      </div>
      <div>
        <label>Tools</label>
        <div class="tools">
          <label><input type="checkbox" value="air_fryer" class="toolChk" />Air fryer</label>
          <label><input type="checkbox" value="bread_machine" class="toolChk" />Bread machine</label>
          <label><input type="checkbox" value="slow_cooker" class="toolChk" />Slow cooker</label>
          <label><input type="checkbox" value="instant_pot" class="toolChk" />Instant Pot</label>
        </div>
      </div>
    </div>
    <button id="chatBtn">‚ú® Suggest recipes</button>
    <div id="chatOutput" style="margin-top:1rem;"></div>
  </section>

  <section id="ingestUrl">
    <h2>Ingest via URL</h2>
    <label for="urlInput">Recipe URL</label>
    <input id="urlInput" type="url" placeholder="https://example.com/my-favorite-recipe" />
    <button id="urlBtn">üåê Crawl &amp; normalize</button>
    <div id="urlResult" style="margin-top:1rem;"></div>
  </section>

  <section id="ingestImage">
    <h2>Ingest via image</h2>
    <p>Upload one or more recipe photos or scans. We run OCR and normalize the result.</p>
    <input id="imageInput" type="file" accept="image/*" multiple />
    <button id="imageBtn">üñºÔ∏è Normalize images</button>
    <div id="imageResult" style="margin-top:1rem;"></div>
  </section>

  <section id="prefs">
    <h2>User preferences</h2>
    <div class="row">
      <div>
        <label for="prefsUser">User ID</label>
        <input id="prefsUser" type="text" placeholder="household-123" />
      </div>
      <div>
        <label for="prefsCuisines">Favored cuisines</label>
        <input id="prefsCuisines" type="text" placeholder="thai, mexican" />
      </div>
      <div>
        <label for="prefsDislikes">Disliked ingredients</label>
        <input id="prefsDislikes" type="text" placeholder="olives, cilantro" />
      </div>
      <div>
        <label for="prefsTools">Favored tools</label>
        <input id="prefsTools" type="text" placeholder="air_fryer, grill" />
      </div>
    </div>
    <label for="prefsNotes">Notes</label>
    <textarea id="prefsNotes" placeholder="Anything else to remember"></textarea>
    <div class="row" style="margin-top:0.75rem;">
      <button id="loadPrefs">üì• Load</button>
      <button id="savePrefs" class="secondary">üíæ Save</button>
    </div>
    <div id="prefsResult" style="margin-top:1rem;"></div>
  </section>

  <section id="themes">
    <h2>Theme suggestions</h2>
    <label for="themeSeed">Theme seed</label>
    <input id="themeSeed" type="text" placeholder="peach" />
    <button id="themeBtn">üçë Fetch ideas</button>
    <div id="themeResult" style="margin-top:1rem;"></div>
  </section>

  <section id="logs">
    <h2>Request logs</h2>
    <div class="row" style="align-items:center;">
      <div>
        <label for="logLimit">Limit</label>
        <input id="logLimit" type="text" value="50" />
      </div>
      <div>
        <label for="logLevel">Level</label>
        <input id="logLevel" type="text" placeholder="info | error" />
      </div>
      <button id="refreshLogs">üîÑ Refresh</button>
    </div>
    <div style="overflow-x:auto; max-height:320px;">
      <table>
        <thead>
          <tr><th>Timestamp</th><th>Level</th><th>Route</th><th>Method</th><th>Status</th><th>ms</th><th>Message</th><th>Meta</th></tr>
        </thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>
  </section>

  <footer>
    Built for AI-assisted recipe exploration. Need the schema? <a href="/openapi.json">Grab the OpenAPI file</a>.
  </footer>

  <script>
    const apiKeyInput = document.getElementById('apiKey');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recordingStatus = document.getElementById('recordingStatus');
    const transcribeResult = document.getElementById('transcribeResult');
    const ingredientsInput = document.getElementById('ingredients');
    const chatBtn = document.getElementById('chatBtn');
    const chatOutput = document.getElementById('chatOutput');
    const urlBtn = document.getElementById('urlBtn');
    const urlInput = document.getElementById('urlInput');
    const urlResult = document.getElementById('urlResult');
    const imageBtn = document.getElementById('imageBtn');
    const imageInput = document.getElementById('imageInput');
    const imageResult = document.getElementById('imageResult');
    const prefsUser = document.getElementById('prefsUser');
    const prefsCuisines = document.getElementById('prefsCuisines');
    const prefsDislikes = document.getElementById('prefsDislikes');
    const prefsTools = document.getElementById('prefsTools');
    const prefsNotes = document.getElementById('prefsNotes');
    const prefsResult = document.getElementById('prefsResult');
    const loadPrefs = document.getElementById('loadPrefs');
    const savePrefs = document.getElementById('savePrefs');
    const themeSeed = document.getElementById('themeSeed');
    const themeBtn = document.getElementById('themeBtn');
    const themeResult = document.getElementById('themeResult');
    const logsBody = document.getElementById('logsBody');
    const refreshLogs = document.getElementById('refreshLogs');
    const logLimit = document.getElementById('logLimit');
    const logLevel = document.getElementById('logLevel');
    const userIdInput = document.getElementById('userId');
    const toolCheckboxes = Array.from(document.querySelectorAll('.toolChk'));
    const themeInput = document.getElementById('theme');

    const storageKey = 'menuforge-api-key';
    apiKeyInput.value = localStorage.getItem(storageKey) || '';
    apiKeyInput.addEventListener('input', () => localStorage.setItem(storageKey, apiKeyInput.value.trim()));

    function authHeaders(extra = {}) {
      const key = apiKeyInput.value.trim();
      if (!key) throw new Error('API key required');
      return Object.assign({ 'X-API-Key': key }, extra);
    }

    async function callJson(url, options = {}) {
      const res = await fetch(url, options);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText);
      return data;
    }

    async function handleChat() {
      try {
        chatBtn.disabled = true;
        chatOutput.innerHTML = 'Loading‚Ä¶';
        const tools = toolCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
        const payload = {
          ingredients: ingredientsInput.value.split(',').map(s => s.trim()).filter(Boolean),
          theme: themeInput.value.trim() || undefined,
          tools,
          userId: userIdInput.value.trim() || undefined,
        };
        const data = await callJson('/api/chat/ingredients', {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload),
        });
        chatOutput.innerHTML = `
          <h3>Assistant message</h3>
          <pre>${data.message || ''}</pre>
          <h3>Suggestions</h3>
          <ol>${(data.suggestions || []).map(r => `<li><strong>${r.title}</strong> <small>${(r.cuisine || '')}</small><br/><span class="pill">${(r.tags || []).join(', ')}</span></li>`).join('')}</ol>
        `;
      } catch (err) {
        chatOutput.innerHTML = `<pre>${err.message}</pre>`;
      } finally {
        chatBtn.disabled = false;
      }
    }
    chatBtn.addEventListener('click', handleChat);

    async function handleUrl() {
      try {
        urlBtn.disabled = true;
        urlResult.textContent = 'Loading‚Ä¶';
        const data = await callJson('/api/ingest/url', {
          method: 'POST',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ url: urlInput.value.trim() }),
        });
        urlResult.innerHTML = `<pre>${JSON.stringify(data.recipe, null, 2)}</pre>`;
      } catch (err) {
        urlResult.innerHTML = `<pre>${err.message}</pre>`;
      } finally {
        urlBtn.disabled = false;
      }
    }
    urlBtn.addEventListener('click', handleUrl);

    async function handleImages() {
      try {
        imageBtn.disabled = true;
        imageResult.textContent = 'Loading‚Ä¶';
        const form = new FormData();
        Array.from(imageInput.files || []).forEach(file => form.append('file', file));
        const res = await fetch('/api/ingest/image', {
          method: 'POST',
          headers: authHeaders(),
          body: form,
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || res.statusText);
        imageResult.innerHTML = `<pre>${JSON.stringify(data.recipe, null, 2)}</pre>`;
      } catch (err) {
        imageResult.innerHTML = `<pre>${err.message}</pre>`;
      } finally {
        imageBtn.disabled = false;
      }
    }
    imageBtn.addEventListener('click', handleImages);

    async function handlePrefsLoad() {
      try {
        prefsResult.textContent = 'Loading‚Ä¶';
        const params = new URLSearchParams({ userId: prefsUser.value.trim() });
        const data = await callJson(`/api/prefs?${params.toString()}`, { headers: authHeaders() });
        const prefs = data.preferences || {};
        prefsCuisines.value = (prefs.cuisines || []).join(', ');
        prefsDislikes.value = (prefs.dislikedIngredients || []).join(', ');
        prefsTools.value = (prefs.favoredTools || []).join(', ');
        prefsNotes.value = prefs.notes || '';
        prefsResult.innerHTML = `<pre>${JSON.stringify(prefs, null, 2)}</pre>`;
      } catch (err) {
        prefsResult.innerHTML = `<pre>${err.message}</pre>`;
      }
    }
    loadPrefs.addEventListener('click', handlePrefsLoad);

    async function handlePrefsSave() {
      try {
        prefsResult.textContent = 'Saving‚Ä¶';
        const payload = {
          userId: prefsUser.value.trim(),
          cuisines: prefsCuisines.value,
          dislikedIngredients: prefsDislikes.value,
          favoredTools: prefsTools.value,
          notes: prefsNotes.value,
        };
        const data = await callJson('/api/prefs', {
          method: 'PUT',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload),
        });
        prefsResult.innerHTML = `<pre>${JSON.stringify(data.preferences, null, 2)}</pre>`;
      } catch (err) {
        prefsResult.innerHTML = `<pre>${err.message}</pre>`;
      }
    }
    savePrefs.addEventListener('click', handlePrefsSave);

    async function handleTheme() {
      try {
        themeResult.textContent = 'Loading‚Ä¶';
        const params = new URLSearchParams({ seed: themeSeed.value.trim() });
        const data = await callJson(`/api/themes/suggest?${params.toString()}`, { headers: authHeaders() });
        themeResult.innerHTML = `<ol>${(data.recipes || []).map(r => `<li>${r.title} <span class="pill">${(r.tags || []).join(', ')}</span></li>`).join('')}</ol>`;
      } catch (err) {
        themeResult.innerHTML = `<pre>${err.message}</pre>`;
      }
    }
    themeBtn.addEventListener('click', handleTheme);

    async function handleLogs() {
      try {
        logsBody.innerHTML = '<tr><td colspan="8">Loading‚Ä¶</td></tr>';
        const params = new URLSearchParams();
        if (logLimit.value.trim()) params.set('limit', logLimit.value.trim());
        if (logLevel.value.trim()) params.set('level', logLevel.value.trim());
        const data = await callJson(`/api/logs?${params.toString()}`, { headers: authHeaders() });
        logsBody.innerHTML = '';
        (data.items || []).forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.ts || ''}</td>
            <td>${row.level || ''}</td>
            <td>${row.route || ''}</td>
            <td>${row.method || ''}</td>
            <td>${row.status || ''}</td>
            <td>${row.ms || ''}</td>
            <td>${row.msg || ''}</td>
            <td><details><summary>meta</summary><pre>${JSON.stringify(row.meta || {}, null, 2)}</pre></details></td>`;
          logsBody.appendChild(tr);
        });
      } catch (err) {
        logsBody.innerHTML = `<tr><td colspan="8"><pre>${err.message}</pre></td></tr>`;
      }
    }
    refreshLogs.addEventListener('click', handleLogs);

    let mediaRecorder = null;
    let audioChunks = [];

    async function startRecording() {
      try {
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        recordingStatus.hidden = false;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => { if (event.data.size) audioChunks.push(event.data); };
        mediaRecorder.onstop = async () => {
          recordingStatus.hidden = true;
          recordBtn.disabled = false;
          stopBtn.disabled = true;
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const form = new FormData();
          form.append('file', blob, 'voice.webm');
          try {
            const res = await fetch('/api/transcribe', { method: 'POST', headers: authHeaders(), body: form });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || res.statusText);
            transcribeResult.textContent = data.text || '';
            ingredientsInput.value = data.text || ingredientsInput.value;
          } catch (err) {
            transcribeResult.textContent = err.message;
          }
        };
        mediaRecorder.start();
      } catch (err) {
        recordingStatus.hidden = true;
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        transcribeResult.textContent = err.message || 'Microphone permission denied.';
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    }

    recordBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);

    if (apiKeyInput.value) {
      handleLogs().catch(() => {});
    }
  </script>
</body>
</html>
